# 系统架构

## 项目结构

```
emotion-analysis-toolkit/
├── hidden_emotion_detection/   # 实时视频隐藏情绪检测系统（PyQt5 GUI）
│   └── evaluation/             #   离线评估框架（CASME II、STRS）
├── micro_expression/           # 微表情识别模型训练（CNN+LSTM 两阶段）
├── macro_expression/           # 宏表情识别模型训练（FER2013 等）
├── docs/                       # 项目文档
└── references/                 # 参考实现（MEGC 竞赛代码）
```

详细目录规范见 `docs/04-开发指南/04-目录结构与存储规范.md`。

## 实时检测系统数据流

```
摄像头输入 → FaceDetectionEngine → PoseEstimator
                    ↓
     ┌──────────────┼──────────────┐
     ↓              ↓              ↓
MacroEmotionEngine MicroEmotionEngine AUEngine
     ↓          OpticalFlowSpottingEngine
     ↓              ↓              ↓
     └──────────────┼──────────────┘
                    ↓
          EmotionIntegrator
                    ↓
        HiddenEmotionEngine（冲突检测）
                    ↓
          6-Panel PyQt5 UI
```

## 分层架构

### core/ — 基础设施层
- `EventBus` — 单例，异步发布/订阅事件总线
- `data_types.py` — EmotionType 枚举、FaceDetection、EmotionResult、AUResult 等数据结构
- `pipeline.py` — 通用管道阶段抽象

### engines/ — 引擎层
- `face_detection_engine.py` — 人脸检测（MediaPipe/dlib）
- `pose_estimator.py` — 头部姿态估计（pitch/yaw/roll）
- `macro_emotion_engine.py` — 宏表情识别（7类基本情绪）
- `micro_emotion_engine.py` — 微表情检测（CNN+LSTM 集成）
- `optical_flow_spotting_engine.py` — 光流微表情 Spotting（7-ROI Farneback 光流）
- `au_engine.py` — AU 检测（SVM 分类器）
- `hidden_emotion_engine.py` — 隐藏情绪分析（宏微冲突检测）
- `emotion_integrator.py` — 结果聚合

### evaluation/ — 离线评估
- `extract_roi_features.py` — ROI 光流特征提取（cv2 + dlib）
- `train_transformer.py` — ROI Transformer LOSO 训练（纯 PyTorch）
- `evaluate_casme2.py` — CASME II Spotting 评估
- `strs_metric.py` — STRS 指标计算

### ui/ — 界面层
- `LayoutManager` 编排 6 列布局
- 各面板继承 `BasePanel`：video / face / au_intensity / macro_emotion / micro_emotion / hidden_emotion

### config/ — 配置层
- `ConfigManager` 集中管理，配置文件为 `config/config.json`

## 核心设计模式

- **事件驱动** — EventBus 松耦合各引擎
- **多线程** — 线程池并行处理各引擎
- **单例配置** — ConfigManager 全局统一

## 微表情两阶段训练

1. **Stage 1 (CNN)**: `train_cnn.py` → 训练 CNN 特征提取器
2. **特征提取**: `extract_features.py` → 用 CNN 提取序列特征
3. **Stage 2 (LSTM)**: `train_lstm.py` → LSTM 时序模型，StratifiedGroupKFold 交叉验证

## 离线评估流程

1. **特征提取**: `extract_roi_features.py` → 7-ROI 光流特征 (.npy)
2. **Transformer 训练**: `train_transformer.py` → LOSO 交叉验证 → UF1/UAR
3. **Spotting 评估**: `evaluate_casme2.py` → STRS 指标
