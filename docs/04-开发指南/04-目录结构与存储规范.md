# 目录结构与存储规范

## 项目总览

```
emotion-analysis-toolkit/
├── hidden_emotion_detection/   # 子项目1: 实时视频隐藏情绪检测系统
├── micro_expression/           # 子项目2: 微表情识别模型训练
├── macro_expression/           # 子项目3: 宏表情识别模型训练
├── docs/                       # 项目文档（按编号分类）
├── references/                 # 参考实现（第三方代码，不修改）
├── 旧有文件/                    # 历史遗留（不纳入 git，仅本地保留）
├── CLAUDE.md                   # AI 协作指导文件
└── .gitignore
```

---

## 一、子项目目录规范

### hidden_emotion_detection/ — 实时检测系统

```
hidden_emotion_detection/
├── main.py                     # 启动入口
├── app.py                      # 应用初始化
├── requirements.txt
├── config/                     # 配置层
│   ├── config.json             #   运行时配置（模型路径、参数）
│   ├── config_manager.py       #   配置管理器
│   ├── models.py               #   配置数据模型
│   └── ui_settings.py          #   UI 配置
├── core/                       # 基础设施层
│   ├── event_bus.py            #   事件总线（单例）
│   ├── data_types.py           #   数据结构定义
│   ├── pipeline.py             #   管道抽象
│   └── ...
├── engines/                    # 引擎层（业务逻辑）
│   ├── face_detection_engine.py
│   ├── macro_emotion_engine.py
│   ├── micro_emotion_engine.py
│   ├── optical_flow_spotting_engine.py
│   ├── au_engine.py
│   ├── emotion_integrator.py
│   ├── hidden_emotion_engine.py
│   └── au_detection/           #   AU 检测子模块
├── ui/                         # 界面层（PyQt5）
│   ├── layout_manager.py       #   6 列布局
│   └── *_panel.py              #   各功能面板
├── models/                     # 模型权重（不纳入 git）
│   ├── shape_predictor_68_face_landmarks.dat
│   ├── blaze_face_short_range.tflite
│   └── svm_models/             #   SVM 模型文件
├── evaluation/                 # 离线评估框架
│   ├── extract_roi_features.py #   ROI 光流特征提取
│   ├── train_transformer.py    #   Transformer 训练
│   ├── evaluate_casme2.py      #   CASME II 评估
│   ├── strs_metric.py          #   STRS 指标
│   └── features_casme2/        #   预提取特征（不纳入 git）
└── utils/                      # 工具函数
```

### micro_expression/ — 微表情训练

```
micro_expression/
├── train_cnn.py                # Stage 1: CNN 训练
├── extract_features.py         # 特征提取
├── train_lstm.py               # Stage 2: LSTM 训练
├── hpo_train.py                # 超参数搜索
├── models.py                   # 模型定义（CNNModel, LSTMOnlyModel, ROITransformerModel 等）
├── dataset.py                  # 图像数据集
├── feature_dataset.py          # 特征序列数据集
├── transforms.py               # 数据增强
├── utils.py                    # 常量和工具（MICRO_EMOTION_MAP, NUM_CLASSES）
├── config_cnn_stage1.yaml      # CNN 配置
├── config_feature_extraction.yaml
├── config_lstm_stage2.yaml     # LSTM 配置
├── config_lstm_stage2_5class.yaml
├── archived_models/            # 历史模型实现（保留参考，不活跃）
│   ├── model_factory.py        #   模型工厂
│   ├── dmca_net*.py            #   DMCANet 系列
│   ├── advanced_models.py      #   Transformer 等高级模型
│   └── hybrid_models.py        #   混合模型
└── requirements.txt
```

### macro_expression/ — 宏表情训练

```
macro_expression/
├── multi_dataset_train.py      # 多数据集训练入口
├── emotion_model.py            # 模型定义（get_emotion_model 工厂）
└── requirements.txt
```

---

## 二、文档目录规范

```
docs/
├── 01-快速开始/
│   ├── 01-环境搭建.md
│   └── 02-常用命令.md
├── 02-核心架构/
│   └── 01-系统架构.md
├── 03-训练指南/
│   ├── 01-微表情训练.md
│   ├── 02-宏表情训练.md
│   ├── 03-微表情领域参考索引.md
│   └── 04-评估框架使用指南.md      ← 新增
├── 04-开发指南/
│   ├── 01-开发约定.md
│   ├── 02-数据集申请指南.md
│   ├── 03-技术迭代路线.md
│   └── 04-目录结构与存储规范.md    ← 本文件
└── 05-子项目说明/                  ← 新增
    ├── 01-实时检测系统.md
    ├── 02-微表情训练工具集.md
    └── 03-宏表情训练工具集.md
```

编号规则：`{大类编号}-{文档序号}`，同一大类内按创建时间递增，编号不重复。

---

## 三、文件命名规范

### Python 文件

| 类型 | 命名规则 | 示例 |
|------|---------|------|
| 模块 | `snake_case.py` | `train_cnn.py`, `emotion_model.py` |
| 配置 | `config_*.yaml` 或 `config_*.json` | `config_cnn_stage1.yaml` |
| 测试 | `test_*.py` | `test_event_bus.py` |

### 模型权重文件

| 类型 | 命名规则 | 示例 |
|------|---------|------|
| PyTorch | `{模型名}_{数据集}_{版本}.pth` | `cnn_casme2_v1.pth` |
| scikit-learn | `{AU编号}_{类型}.pkl` | `AU01_svm.pkl`, `AU01_scaler.pkl` |
| dlib | 保持原始命名 | `shape_predictor_68_face_landmarks.dat` |
| TFLite | 保持原始命名 | `blaze_face_short_range.tflite` |

### 训练输出

| 类型 | 存储位置 | 命名规则 |
|------|---------|---------|
| CNN 权重 | `outputs/cnn/` | `best_model.pth`, `epoch_{N}.pth` |
| LSTM 权重 | `outputs/lstm/` | `best_model.pth`, `fold_{K}.pth` |
| 训练日志 | `outputs/logs/` | `{实验名}_{日期}.log` |
| 评估结果 | `outputs/eval/` | `{数据集}_{方法}_{日期}.json` |
| 超参搜索 | `outputs/hpo/` | `trial_{N}/` |

> 注意：`outputs/` 目录不纳入 git，在 `.gitignore` 中排除。

### 特征文件

| 类型 | 存储位置 | 命名规则 |
|------|---------|---------|
| ROI 光流特征 | `evaluation/features_{数据集}/` | `sub{被试}_{视频}.npy` |
| 特征清单 | 同上 | `manifest.json` |
| 元信息 | 同上 | `sub{被试}_{视频}.json` |

---

## 四、.gitignore 规则

以下内容不纳入版本控制：

```gitignore
# 模型权重
*.pth
*.pt
*.pkl
*.dat
*.tflite
*.xml

# 训练输出
outputs/
stage1_cnn_output/
stage2_lstm_output/

# 特征文件
features_*/
*.npy

# 数据集
旧有文件/
data/

# 环境
.venv*/
__pycache__/

# 临时文件
_*.txt
_*.json
_*.csv
nul

# 参考代码（体积大，按需克隆）
references/
```

例外（需要纳入 git 的模型相关文件）：
- `hidden_emotion_detection/models/macro_models.py`（模型定义代码，非权重）
- `*.yaml`, `*.json`（配置文件）

---

## 五、数据集存储规范

数据集不纳入 git，本地存储在 `旧有文件/` 或独立目录。

| 数据集 | 本地路径 | 说明 |
|--------|---------|------|
| CASME II | `旧有文件/18/data/raw/CASME II/` | 26 被试，255 标注 |
| FER2013 | 按 macro_expression 配置 | 公开数据集 |
| CAS(ME)³ | 待申请 | 需签署协议 |
| SMIC | 待申请 | 需签署协议 |
| SAMM | 待申请 | 需签署协议 |

---

## 六、配置文件管理

| 配置文件 | 位置 | 说明 |
|---------|------|------|
| 系统运行配置 | `hidden_emotion_detection/config/config.json` | 模型路径（绝对路径，部署时需修改） |
| CNN 训练配置 | `micro_expression/config_cnn_stage1.yaml` | 数据路径、超参数 |
| LSTM 训练配置 | `micro_expression/config_lstm_stage2.yaml` | 特征路径、超参数 |
| 特征提取配置 | `micro_expression/config_feature_extraction.yaml` | CNN 权重路径 |

配置文件中的路径使用相对路径（相对于项目根目录），运行时通过 `-m` 模块方式自动解析。
`config.json` 例外，使用绝对路径（历史原因），部署新环境时需手动修改。
