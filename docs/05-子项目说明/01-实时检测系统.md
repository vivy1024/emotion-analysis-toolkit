# 实时检测系统

## 概述

实时视频隐藏情绪检测系统，基于 PyQt5 构建 6 面板 GUI，通过多引擎并行分析摄像头画面中的面部表情、微表情、AU 动作单元，检测宏微表情冲突来推断隐藏情绪。

## 启动

```bash
python -m hidden_emotion_detection.main
# 可选参数: --debug, --log-level DEBUG/INFO/WARNING
```

## 架构

### 数据流

```
摄像头 → FaceDetectionEngine → PoseEstimator
                ↓
     ┌──────────┼──────────┐
     ↓          ↓          ↓
  Macro      Micro       AU
  Engine     Engine     Engine
     ↓          ↓          ↓
     └──────────┼──────────┘
                ↓
      EmotionIntegrator
                ↓
    HiddenEmotionEngine（冲突检测）
                ↓
        6-Panel PyQt5 UI
```

### 分层

| 层 | 目录 | 职责 |
|----|------|------|
| 配置 | `config/` | ConfigManager 集中管理，`config.json` 存储模型路径和参数 |
| 基础设施 | `core/` | EventBus 事件总线、数据结构定义、管道抽象 |
| 引擎 | `engines/` | 各检测引擎，通过 EventBus 通信，线程池并行执行 |
| 界面 | `ui/` | LayoutManager 6 列布局，各面板继承 BasePanel |
| 工具 | `utils/` | 日志、装饰器 |
| 评估 | `evaluation/` | 离线评估框架（CASME II、STRS 指标） |

### 核心引擎

| 引擎 | 文件 | 功能 |
|------|------|------|
| 人脸检测 | `face_detection_engine.py` | MediaPipe/dlib 人脸检测 + 68 点关键点 |
| 姿态估计 | `pose_estimator.py` | 头部 pitch/yaw/roll 估计 |
| 宏表情 | `macro_emotion_engine.py` | PyTorch CNN 7 类情绪分类 |
| 微表情 | `micro_emotion_engine.py` | CNN-LSTM 微表情识别 |
| 光流 Spotting | `optical_flow_spotting_engine.py` | 7-ROI 光流微表情检测 |
| AU 检测 | `au_engine.py` + `au_detection/` | SVM 动作单元强度估计 |
| 情绪融合 | `emotion_integrator.py` | 多源情绪结果加权融合 |
| 隐藏情绪 | `hidden_emotion_engine.py` | 宏微冲突检测 → 隐藏情绪推断 |

### 核心设计模式

- 事件驱动: EventBus 单例，引擎间通过发布/订阅解耦
- 多线程: 线程池并行执行各引擎，避免 UI 阻塞
- 单例配置: ConfigManager 全局唯一

## 配置

`config/config.json` 关键字段：

```json
{
  "system": {
    "models_dir": "绝对路径/hidden_emotion_detection/models",
    "video_source": 0,
    "gpu_enabled": true,
    "thread_pool_size": 4
  },
  "face": {
    "detection_method": "mediapipe",
    "landmark_method": "dlib"
  },
  "macro": {
    "model_path": "绝对路径/models/macro.pt"
  },
  "micro": {
    "model_path": "绝对路径/models/micro.pt"
  }
}
```

> 部署新环境时需修改所有绝对路径。

## 模型文件

| 文件 | 用途 | 来源 |
|------|------|------|
| `shape_predictor_68_face_landmarks.dat` | dlib 68 点关键点 | dlib 官方 |
| `blaze_face_short_range.tflite` | MediaPipe 人脸检测 | Google MediaPipe |
| `macro.pt` | 宏表情 CNN | macro_expression 训练产出 |
| `micro.pt` | 微表情 CNN-LSTM | micro_expression 训练产出 |
| `svm_models/AU*.pkl` | AU SVM 分类器 | 自训练 |

## 依赖

```
PyQt5, torch, opencv-python, dlib, mediapipe, numpy, scikit-learn
```
