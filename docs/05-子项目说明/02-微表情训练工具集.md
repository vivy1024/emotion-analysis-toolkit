# 微表情训练工具集

## 概述

微表情识别模型训练工具集，采用两阶段训练策略：CNN 提取空间特征 → LSTM 建模时序关系。支持超参数搜索和 LOSO 交叉验证。

## 训练流程

```
原始图像序列
    ↓
Stage 1: CNN 训练 (train_cnn.py)
    → 输出: CNN 权重 (.pth)
    ↓
特征提取 (extract_features.py)
    → 输出: 特征向量序列 (.npy)
    ↓
Stage 2: LSTM 训练 (train_lstm.py)
    → 输出: LSTM 权重 (.pth)
    ↓
可选: 超参数搜索 (hpo_train.py)
```

## 命令

```bash
# Stage 1: CNN
python -m micro_expression.train_cnn --config micro_expression/config_cnn_stage1.yaml

# 特征提取
python -m micro_expression.extract_features --config micro_expression/config_feature_extraction.yaml

# Stage 2: LSTM
python -m micro_expression.train_lstm --config micro_expression/config_lstm_stage2.yaml

# 超参数搜索
python -m micro_expression.hpo_train --config micro_expression/config_lstm_stage2.yaml
```

## 模型架构

### models.py 中的模型

| 模型 | 类名 | 用途 | 参数量 |
|------|------|------|--------|
| CNN | `CNNModel` | Stage 1 空间特征提取 | ~2M |
| LSTM | `LSTMOnlyModel` | Stage 2 时序建模 | ~500K |
| CNN-LSTM | `CNN_LSTM_Model` | 端到端联合训练 | ~2.5M |
| ROI Transformer | `ROITransformerModel` | ROI 光流分类（评估用） | ~50K |

### ROITransformerModel 详细

参考 MEGC2024 STR 第二名方案，适配 7-ROI 光流特征：

```
输入 (B, T, 14) → Linear 投影 → +CLS token → +位置编码
    → 3层 Pre-LN Transformer Encoder (dim=64, heads=4)
    → CLS token → MLP Head → 4类分类
```

### archived_models/ 历史模型

保留在 `archived_models/` 目录供参考，不参与当前训练流程：

| 文件 | 内容 |
|------|------|
| `model_factory.py` | ModelFactory 注册/创建模式，5 种模型 |
| `dmca_net*.py` | DMCANet 系列（双流多尺度通道注意力） |
| `advanced_models.py` | Transformer、SE-ResNet 等 |
| `hybrid_models.py` | 混合架构 |

## 配置文件

### config_cnn_stage1.yaml

```yaml
data:
  root: "数据集路径"
  image_size: 128
  augmentation: true
model:
  num_classes: 7
  input_channels: 1
training:
  epochs: 50
  batch_size: 32
  lr: 0.001
  optimizer: adam
output:
  dir: "stage1_cnn_output"
```

### config_lstm_stage2.yaml

```yaml
data:
  features_dir: "stage1_cnn_output/features"
  sequence_length: 16
model:
  hidden_size: 128
  num_layers: 2
  dropout: 0.3
training:
  epochs: 100
  batch_size: 16
  lr: 0.0005
  cv_folds: 5
  cv_method: "StratifiedGroupKFold"
output:
  dir: "stage2_lstm_output"
```

## 情绪类别

### 7 类（CASME II 原始）

```python
MICRO_EMOTION_MAP = {
    'happiness': 0, 'disgust': 1, 'repression': 2,
    'surprise': 3, 'fear': 4, 'sadness': 5, 'others': 6
}
```

### 4 类（MEGC 标准）

```python
EMOTION_MAP_4CLASS = {
    'happiness': 1,      # positive
    'surprise': 2,       # surprise
    'disgust': 3,        # negative
    'repression': 3,     # negative
    'fear': 3, 'sadness': 3, 'contempt': 3, 'tense': 3,
    'others': 0          # others
}
```

## 输出目录

```
stage1_cnn_output/          # CNN 训练输出（不纳入 git）
├── best_model.pth
├── training_log.csv
└── features/               # 提取的特征

stage2_lstm_output/          # LSTM 训练输出（不纳入 git）
├── best_model.pth
├── fold_*/
└── training_log.csv
```
