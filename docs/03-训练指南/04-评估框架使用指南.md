# 评估框架使用指南

## 概述

离线评估框架，在 CASME II 数据集上评估微表情 Spotting 和 Recognition 性能。支持 LOSO 协议和 STRS 指标。

位于 `hidden_emotion_detection/evaluation/`。

## 两阶段流程

```
阶段1: 特征提取（需要 cv2 + dlib）
    extract_roi_features.py → features_casme2/*.npy

阶段2: 训练评估（纯 PyTorch）
    train_transformer.py → 读取 .npy → LOSO 训练 → 结果 JSON
```

拆分为两阶段的原因：cv2 在某些环境下有 DLL 兼容问题，分离后训练阶段可在任何有 PyTorch 的环境运行。

## 命令

### 特征提取

```bash
# 提取全部 26 被试（约 20 分钟）
python -m hidden_emotion_detection.evaluation.extract_roi_features

# 只提取指定被试（快速测试）
python -m hidden_emotion_detection.evaluation.extract_roi_features --subjects 09 15

# 自定义参数
python -m hidden_emotion_detection.evaluation.extract_roi_features \
    --data_root "旧有文件/18/data/raw/CASME II" \
    --predictor "hidden_emotion_detection/models/shape_predictor_68_face_landmarks.dat" \
    --output_dir "hidden_emotion_detection/evaluation/features_casme2"
```

已提取的样本会自动跳过（断点续传）。

### Transformer 训练

```bash
# 全量 LOSO 训练
python -m hidden_emotion_detection.evaluation.train_transformer \
    --epochs 30 --output_json results.json

# 快速测试
python -m hidden_emotion_detection.evaluation.train_transformer \
    --subjects 09 15 --epochs 5

# 调参
python -m hidden_emotion_detection.evaluation.train_transformer \
    --dim 64 --depth 3 --heads 4 --lr 0.001 --dropout 0.1
```

### Spotting 评估

```bash
python -m hidden_emotion_detection.evaluation.evaluate_casme2 \
    --subjects 09 --peak_threshold 0.1
```

## 特征格式

### ROI 光流特征

每个样本保存为 `.npy` 文件，shape 为 `(T, 14)`：
- T: 帧数（onset-offset 区间）
- 14: 7 个 ROI × 2 (dx, dy)

7 个 ROI 区域：

| 编号 | 区域 | dlib 关键点 |
|------|------|------------|
| 0 | 左眉 | 17-21 |
| 1 | 右眉 | 22-26 |
| 2 | 左眼 | 36-41 |
| 3 | 右眼 | 42-47 |
| 4 | 鼻子 | 27-35 |
| 5 | 外嘴唇 | 48-59 |
| 6 | 内嘴唇 | 60-67 |

全局运动补偿：减去鼻梁区域（关键点 29-31）的光流均值。

### manifest.json

```json
[
  {
    "sample_id": "sub09_EP02_01f",
    "subject": "09",
    "video": "EP02_01f",
    "emotion": "happiness",
    "label": 1,
    "onset": 56,
    "offset": 126,
    "npy_file": "sub09_EP02_01f.npy",
    "shape": [69, 14]
  }
]
```

## 评估指标

### STRS (Spot-Then-Recognize Score)

```
STRS = Spotting_F1 × Recognition_F1
```

- Spotting F1: IoU ≥ 0.5 判定为 TP，贪心匹配
- Recognition F1: 仅对 TP 样本评估情绪分类

### UF1 / UAR

- UF1 (Unweighted F1): 各类 F1 的算术平均
- UAR (Unweighted Average Recall): 各类 Recall 的算术平均

### 4 类情绪映射

| 类别 | 标签 | CASME II 原始情绪 |
|------|------|------------------|
| others | 0 | others |
| positive | 1 | happiness |
| surprise | 2 | surprise |
| negative | 3 | disgust, repression, fear, sadness, contempt, tense |

## 当前 Baseline 结果

| 配置 | 被试数 | 样本数 | UF1 | UAR |
|------|--------|--------|-----|-----|
| sub09+sub15 | 2 | 17 | 0.1056 | 0.0774 |
| 全量 26 被试 | 26 | 255 | 0.1861 | 0.2157 |

模型配置：dim=64, depth=3, heads=4, mlp_dim=128, epochs=30, lr=0.001

## 已知问题

1. CASME II 标注的 onset-offset 跨度较大（40-130 帧），光流 Spotting 检测的区间较短（5-20 帧），导致 IoU 难以达到 0.5
2. 类别严重不平衡，others 类占多数
3. 255 个样本对 Transformer 来说偏少，传统方法（SVM）可能更适合
