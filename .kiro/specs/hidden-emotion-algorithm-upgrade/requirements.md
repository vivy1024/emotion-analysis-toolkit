# Requirements: 隐藏情绪检测算法升级（Phase 1）

## Introduction

当前 hidden_emotion_engine.cpp 使用简单加权平均（VA距离 + AU匹配率）判定隐藏情绪，与论文《人脸微表情与意图识别系统设计》描述的算法存在重大差距。论文定义了七元掩饰矩阵、D-S证据理论多层决策、AU分层验证、4种意图模式、时序上下文建模和自适应阈值，但均未实现。

**目标**: 将论文算法完整移植到 C++ 引擎，使系统具备真正的隐藏情绪检测能力。

**优先级**: P0（核心功能缺失）

**代码位置**: `D:\pycharm2\PythonProject2\hidden_emotion_cpp\`

## Requirements

### REQ-1: 七元情绪掩饰矩阵 [P0]
- 实现论文表3.1的 7×7 掩饰矩阵 M[i][j]，替代当前的二元矛盾关系表 kEmotionConflicts
- 矩阵值为精确冲突系数（0.0~1.0），不再是简单的"矛盾/不矛盾"布尔判定
- 矩阵必须对称：M[i][j] = M[j][i]
- 对角线为 0（同类情绪无冲突）
- 高冲突对：Happiness↔Sadness=0.95, Happiness↔Anger=0.90, Happiness↔Fear=0.85
- 中冲突对：Surprise↔Disgust=0.70, Sadness↔Anger=0.65
- 低冲突对：Neutral↔任何=0.30~0.50

### REQ-2: D-S 证据理论多层决策框架 [P0]
- 实现 Dempster-Shafer 证据理论的三层架构：
  - **输入层**: 宏表情概率分布 PM、微表情概率分布 Pm、AU证据 PAU 作为三个独立证据源
  - **证据合成层**: Dempster 合成规则 m₁⊕m₂，处理证据冲突（归一化因子 K = 1 - Σ m₁(A)·m₂(B)，A∩B=∅）
  - **决策层**: 基于合成后的信度函数 Bel(A) 和似然函数 Pl(A) 做最终判定
- 当冲突因子 K > 0.9 时，切换到 Yager 修正规则（将冲突质量分配给全集 Θ）
- 支持多证据源顺序合成：先合成 PM⊕Pm，再合成结果⊕PAU

### REQ-3: AU 分层验证机制 [P1]
- 实现论文3.4.2节的分层验证：
  - **核心AU**（必要条件）: 如 Happiness 必须有 AU6+AU12，缺失则直接否决
  - **辅助AU**（充分条件）: 如 Happiness 的 AU25（嘴唇分开），存在则增强置信度
- AU 强度 Z-score 标准化：z = (x - μ) / σ，基于个体基线（前30帧均值/标准差）
- 核心AU全部激活 → 验证通过（权重1.0）
- 核心AU部分缺失 → 降权（matched/total × 0.7）
- 核心AU全部缺失 → 否决（权重0.0，直接跳过该情绪假设）

### REQ-4: 意图推理引擎 [P1]
- 实现论文3.4.4节的4种意图模式：
  - **抑制(Suppression)**: 微表情强度 < 阈值 且 宏表情为Neutral → 试图隐藏真实情绪
  - **掩饰(Masking)**: 宏微表情矛盾 且 冲突系数 > 0.7 → 用假表情掩盖真实情绪
  - **放大(Amplification)**: 宏微表情一致 但 宏表情强度 > 微表情强度×1.5 → 夸大情绪
  - **一致(Congruence)**: 宏微表情一致 且 强度差 < 0.2 → 真实表达
- 每种模式输出：模式类型 + 置信度 + 文字描述

### REQ-5: 时序上下文建模 [P2]
- 实现情绪状态转移图 G=(V,E)：
  - V = 7种情绪状态
  - E = 状态转移边，权重为转移概率
- 维护最近 N 帧（默认30帧）的情绪历史队列
- 异常转移检测：如果当前情绪与历史趋势的转移概率 < 0.1，标记为"突变"
- 情绪稳定性评分：基于历史队列中主导情绪的占比

### REQ-6: 自适应阈值 [P2]
- 实现论文公式：τ = α + β·(entropy(PM) + variance(Pm))
  - α = 基础阈值（默认0.5）
  - β = 调节系数（默认0.15）
  - entropy(PM) = -Σ p·log(p)，宏表情概率分布的信息熵
  - variance(Pm) = 微表情概率分布的方差
- 高熵（不确定性大）→ 阈值升高 → 更保守的判定
- 低熵（确定性高）→ 阈值降低 → 更敏感的检测

## Out of Scope
- 模型重新训练（Phase 3）
- UI 界面改造（Phase 2）
- 多人脸场景优化（后续迭代）
- 视频文件输入（当前仅摄像头实时流）

## Dependencies
- 当前 ONNX 模型（macro.onnx, micro_cnn.onnx, micro_lstm_fold*.onnx, au.onnx）保持不变
- 论文中的数值参数（掩饰矩阵系数、AU映射表）直接硬编码为编译期常量
